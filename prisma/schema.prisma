// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}



// ==================== ADMIN MODELS ====================

model Admin {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      AdminRole @default(ADMIN)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  events    Event[]
  products  Product[]
  activityLogs AdminActivityLog[]

  @@map("admins")
}

model AdminActivityLog {
  id        String   @id @default(uuid())
  adminId   String
  action    String
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([createdAt])
  @@map("admin_activity_logs")
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  MODERATOR
}

// ==================== EVENT/TICKETING MODELS ====================

model Event {
  id          String   @id @default(uuid())
  title       String
  description String   @db.Text
  venue       String
  address     String
  city        String
  state       String?
  country     String
  date        DateTime
  startTime   String
  endTime     String?
  imageUrl    String?
  status      EventStatus @default(DRAFT)
  totalSeats  Int
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  createdBy    Admin @relation(fields: [createdById], references: [id])
  ticketTypes  TicketType[]
  orders       Order[]

  @@index([status])
  @@index([date])
  @@index([createdById])
  @@map("events")
}

model TicketType {
  id          String   @id @default(uuid())
  eventId     String
  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  quantity    Int
  sold        Int      @default(0)
  maxPerOrder Int      @default(10)
  salesStart  DateTime?
  salesEnd    DateTime?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  event   Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tickets Ticket[]

  @@index([eventId])
  @@map("ticket_types")
}

model Ticket {
  id           String   @id @default(uuid())
  orderId      String
  ticketTypeId String
  qrCode       String   @unique
  status       TicketStatus @default(VALID)
  checkedInAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  order      Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  ticketType TicketType @relation(fields: [ticketTypeId], references: [id])

  @@index([orderId])
  @@index([ticketTypeId])
  @@index([qrCode])
  @@map("tickets")
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum TicketStatus {
  VALID
  USED
  CANCELLED
  REFUNDED
}

// ==================== MERCH STORE MODELS ====================

model Product {
  id          String   @id @default(uuid())
  name        String
  description String   @db.Text
  price       Decimal  @db.Decimal(10, 2)
  imageUrl    String?
  category    String
  stock       Int      @default(0)
  sku         String   @unique
  isActive    Boolean  @default(true)
  isFeatured  Boolean  @default(false)
  weight      Decimal? @db.Decimal(8, 2) // in grams
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  createdBy Admin @relation(fields: [createdById], references: [id])
  variants  ProductVariant[]
  orderItems OrderItem[]

  @@index([category])
  @@index([isActive])
  @@index([createdById])
  @@map("products")
}

model ProductVariant {
  id        String   @id @default(uuid())
  productId String
  name      String   // e.g., "Size: Large, Color: Blue"
  sku       String   @unique
  price     Decimal? @db.Decimal(10, 2) // null means use product price
  stock     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  product    Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@index([productId])
  @@map("product_variants")
}

// ==================== ORDER MODELS ====================

model Order {
  id              String   @id @default(uuid())
  orderNumber     String   @unique
  customerEmail   String
  customerName    String
  customerPhone   String?
  orderType       OrderType
  
  // Event-specific fields
  eventId         String?
  
  // Shipping fields (for merch)
  shippingAddress String?
  shippingCity    String?
  shippingState   String?
  shippingZip     String?
  shippingCountry String?
  
  subtotal        Decimal  @db.Decimal(10, 2)
  shippingFee     Decimal  @db.Decimal(10, 2) @default(0)
  tax             Decimal  @db.Decimal(10, 2) @default(0)
  total           Decimal  @db.Decimal(10, 2)
  
  status          OrderStatus @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)
  paymentMethod   String?
  paymentIntentId String? // Stripe payment intent
  
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  event      Event? @relation(fields: [eventId], references: [id])
  tickets    Ticket[]
  orderItems OrderItem[]
  payments   Payment[]

  @@index([customerEmail])
  @@index([orderNumber])
  @@index([status])
  @@index([eventId])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id               String   @id @default(uuid())
  orderId          String
  productId        String
  productVariantId String?
  quantity         Int
  unitPrice        Decimal  @db.Decimal(10, 2)
  totalPrice       Decimal  @db.Decimal(10, 2)
  createdAt        DateTime @default(now())

  // Relations
  order          Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product        Product @relation(fields: [productId], references: [id])
  productVariant ProductVariant? @relation(fields: [productVariantId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model Payment {
  id              String   @id @default(uuid())
  orderId         String
  amount          Decimal  @db.Decimal(10, 2)
  currency        String   @default("USD")
  paymentMethod   String
  transactionId   String?  @unique
  status          PaymentStatus @default(PENDING)
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([transactionId])
  @@map("payments")
}

enum OrderType {
  TICKET
  MERCH
  MIXED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

// ==================== ANALYTICS & REPORTING ====================

model Analytics {
  id        String   @id @default(uuid())
  metric    String
  value     Decimal  @db.Decimal(15, 2)
  metadata  Json?
  date      DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([metric])
  @@index([date])
  @@map("analytics")
}
